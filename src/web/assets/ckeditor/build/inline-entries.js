(()=>{var e={782:(e,t,n)=>{e.exports=n(237)("./src/core.js")},783:(e,t,n)=>{e.exports=n(237)("./src/engine.js")},311:(e,t,n)=>{e.exports=n(237)("./src/ui.js")},584:(e,t,n)=>{e.exports=n(237)("./src/utils.js")},901:(e,t,n)=>{e.exports=n(237)("./src/widget.js")},237:e=>{"use strict";e.exports=CKEditor5.dll}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,n),a.exports}n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{"use strict";n.r(i),n.d(i,{CraftInlineEntries:()=>m});var e=n(782),t=n(901);class r extends e.Command{execute(e){const t=this.editor,n=t.model.document.selection;t.model.change((i=>{const r=i.createElement("craftInlineEntryModel",{...Object.fromEntries(n.getAttributes()),cardHtml:e.cardHtml,entryId:e.entryId,siteId:e.siteId});t.model.insertObject(r,null,null,{setSelection:"after"})}))}refresh(){const e=this.editor.model.document.selection,t=!e.isCollapsed&&e.getFirstRange();this.isEnabled=!t}}class a extends e.Plugin{static get requires(){return[t.Widget]}static get pluginName(){return"CraftInlineEntriesEditing"}init(){this._defineSchema(),this._defineConverters();const e=this.editor;e.commands.add("insertInlineEntry",new r(e)),e.editing.mapper.on("viewToModelPosition",(0,t.viewToModelPositionOutsideModelElement)(e.model,(e=>{e.hasClass("cke-inline-entry-card")})))}_defineSchema(){this.editor.model.schema.register("craftInlineEntryModel",{inheritAllFrom:"$inlineObject",allowAttributes:["cardHtml","entryId","siteId"],allowChildren:!1})}_defineConverters(){const e=this.editor.conversion;e.for("upcast").elementToElement({view:{name:"craft-inline-entry"},model:(e,{writer:t})=>{const n=e.getAttribute("data-card-html"),i=e.getAttribute("data-entry-id"),r=e.getAttribute("data-site-id")??null;return t.createElement("craftInlineEntryModel",{cardHtml:n,entryId:i,siteId:r})}}),e.for("editingDowncast").elementToElement({model:"craftInlineEntryModel",view:(e,{writer:i})=>{const r=e.getAttribute("entryId")??null,a=e.getAttribute("siteId")??null,d=i.createContainerElement("div",{class:"cke-inline-entry-card","data-entry-id":r,"data-site-id":a});return n(e,i,d),(0,t.toWidget)(d,i)}}),e.for("dataDowncast").elementToElement({model:"craftInlineEntryModel",view:(e,{writer:t})=>{const n=e.getAttribute("entryId")??null,i=e.getAttribute("siteId")??null;return t.createContainerElement("craft-inline-entry",{"data-entry-id":n,"data-site-id":i})}});const n=(e,t,n)=>{this._getCardHtml(e).then((e=>{const i=t.createRawElement("div",null,(function(t){t.innerHTML=e.cardHtml,Craft.appendHeadHtml(e.headHtml),Craft.appendBodyHtml(e.bodyHtml)}));t.insert(t.createPositionAt(n,0),i);const r=this.editor;r.editing.view.focus(),setTimeout((()=>{Craft.cp.elementThumbLoader.load($(r.ui.element))}),100),r.model.change((e=>{r.ui.update(),$(r.sourceElement).trigger("keyup")}))}))}}async _getCardHtml(e){let t=e.getAttribute("cardHtml")??null,n=$(this.editor.sourceElement).parents(".field");const i=$(n[0]).data("layout-element");if(t)return{cardHtml:t};const r=e.getAttribute("entryId")??null,a=e.getAttribute("siteId")??null;try{const e=this.editor,t=$(e.ui.view.element).closest("form,.lp-editor-container").data("elementEditor");t&&(console.log(t),await t.checkForm());const{data:n}=await Craft.sendActionRequest("POST","ckeditor/ckeditor/entry-card-html",{data:{entryId:r,siteId:a,layoutElementUid:i}});return n}catch(e){console.error(e?.response?.data);return{cardHtml:'<div class="element card"><div class="card-content"><div class="card-heading"><div class="label error"><span>'+(e?.response?.data?.message||"An unknown error occurred.")+"</span></div></div></div></div>"}}}}var d=n(311),s=n(783),o=n(584);class l extends s.DomEventObserver{constructor(e){super(e),this.domEventType="dblclick"}onDomEvent(e){this.fire(e.type,e)}}class c extends e.Plugin{static get requires(){return[t.WidgetToolbarRepository]}static get pluginName(){return"CraftInlineEntriesUI"}init(){this.editor.ui.componentFactory.add("createInlineEntry",(e=>this._createToolbarInlineEntriesButton(e))),this.editor.ui.componentFactory.add("editInlineEntryBtn",(e=>this._createEditInlineEntryBtn(e))),this._listenToEvents()}afterInit(){this.editor.plugins.get(t.WidgetToolbarRepository).register("inlineEntriesBalloon",{ariaLabel:Craft.t("ckeditor","Inline Entry toolbar"),items:["editInlineEntryBtn"],getRelatedElement:e=>{const n=e.getSelectedElement();return n&&(0,t.isWidget)(n)&&n.hasClass("cke-inline-entry-card")?n:null}})}_listenToEvents(){const e=this.editor.editing.view,t=e.document;e.addObserver(l),this.editor.listenTo(t,"dblclick",((e,t)=>{const n=this.editor.editing.mapper.toModelElement(t.target.parent);"craftInlineEntryModel"===n.name&&this._initEditEntrySlideout(t,n)}))}_initEditEntrySlideout(e=null,t=null){if(null===t){t=this.editor.model.document.selection.getSelectedElement()}const n=t.getAttribute("entryId"),i=viewElement.getAttribute("siteId")??null;this._showEditEntrySlideout(n,i,t)}_createToolbarInlineEntriesButton(e){const t=this.editor,n=t.config.get("entryTypeOptions"),i=t.commands.get("insertInlineEntry");if(!n||!n.length)return;const r=(0,d.createDropdown)(e);return r.buttonView.set({label:Craft.t("app","New {type}",{type:Craft.t("app","inline entry")}),tooltip:!0,withText:!0}),r.bind("isEnabled").to(i),(0,d.addListToDropdown)(r,(()=>this._getDropdownItemsDefinitions(n,i)),{ariaLabel:Craft.t("ckeditor","Entry types list")}),this.listenTo(r,"execute",(e=>{this._showCreateEntrySlideout(e.source.commandValue)})),r}_getDropdownItemsDefinitions(e,t){const n=new o.Collection;return e.map((e=>{const t={type:"button",model:new d.ViewModel({commandValue:e.value,label:e.label||e.value,icon:e.icon,withText:!0})};n.add(t)})),n}_createEditInlineEntryBtn(e){const t=new d.ButtonView(e);return t.set({isEnabled:!0,label:Craft.t("app","Edit {type}",{type:Craft.elementTypeNames["craft\\elements\\Entry"][2]}),tooltip:!0,withText:!0}),this.listenTo(t,"execute",(e=>{this._initEditEntrySlideout()})),t}getElementEditor(){return $(this.editor.ui.view.element).closest("form,.lp-editor-container").data("elementEditor")}_getCardElement(e){return $(this.editor.ui.element).find('.element.card[data-id="'+e+'"]')}_showEditEntrySlideout(e,t,n){const i=this.editor,r=this.getElementEditor(),a=Craft.createElementEditor(this.elementType,null,{elementId:e,params:{siteId:t},onBeforeSubmit:async()=>{let t=this._getCardElement(e);if(null!==t&&Garnish.hasAttr(t,"data-owner-is-canonical")&&!r.settings.isUnpublishedDraft){await a.elementEditor.checkForm(!0,!0);let e=$(i.sourceElement).attr("name");r&&e&&await r.setFormValue(e,"*"),r.settings.draftId&&a.elementEditor.settings.draftId&&(a.elementEditor.settings.saveParams||(a.elementEditor.settings.saveParams={}),a.elementEditor.settings.saveParams.action="elements/save-nested-element-for-derivative",a.elementEditor.settings.saveParams.newOwnerId=r.getDraftElementId(t.data("owner-id")))}},onSubmit:t=>{let r=this._getCardElement(e);null!==r&&t.data.id!=r.data("id")&&(r.attr("data-id",t.data.id).data("id",t.data.id).data("owner-id",t.data.ownerId),i.editing.model.change((e=>{e.setAttribute("entryId",t.data.id,n),i.ui.update()})),Craft.refreshElementInstances(t.data.id))}})}async _showCreateEntrySlideout(e){const t=this.editor,n=t.config.get("nestedElementAttributes"),i=Object.assign({},n,{typeId:e}),r=this.getElementEditor();let a;r&&(await r.markDeltaNameAsModified(t.sourceElement.name),i.ownerId=r.getDraftElementId(n.ownerId));try{a=(await Craft.sendActionRequest("POST","elements/create",{data:i})).data}catch(e){throw Craft.cp.displayError(e?.response?.data?.error),e}Craft.createElementEditor(this.elementType,{elementId:a.element.id,draftId:a.element.draftId,params:{fresh:1,siteId:a.element.siteId}}).on("submit",(e=>{t.commands.execute("insertInlineEntry",{entryId:e.data.id,siteId:e.data.siteId})}))}}class m extends e.Plugin{static get requires(){return[a,c]}static get pluginName(){return"CraftInlineEntries"}}})(),(window.CKEditor5=window.CKEditor5||{}).inlineEntries=i})();